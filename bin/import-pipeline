#!/usr/bin/env python3
import os
import json
import sys
from optparse import OptionParser
import time
import importlib
from multiprocessing import Process

from lettucethink import fsdb

def process_block(block, scan, inputs, outputs):
    block.read_input(scan, inputs)
    block.process()
    block.write_output(scan, outputs)

def find_id(l, id):
    for x in l:
        if x['id'] == id:
            return x
    return None

if __name__ == "__main__":
    usage = "usage: %prog [options] db/scan pipeline"
    parser = OptionParser(usage=usage)

    parser.add_option("-s", "--skip",
        dest="skip",
        default=0,
        type=int,
        help ="skip the first s tasks")

    (options, args) = parser.parse_args()

    if '-n' in sys.argv:
        i = find('-n')

    if len(args) != 2:
        raise Exception('Wrong number of arguments. Usage: ')

    scan = args[0]
    scan = scan.split('/')
    db = '/'.join(scan[:-1])
    scan = scan[-1]
    print('DB location = %s'%db)
    print('scan = %s'%scan)

    assert(os.path.splitext(args[1])[-1] == ".json")

    tasks = []

    db = fsdb.DB(db)
    db.connect()

    scan = db.get_scan(scan)

    x = scan.get_fileset("pipeline", create=True)
    f = x.create_file("pipeline")
    f.import_file(args[1])

