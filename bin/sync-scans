#!/usr/bin/env python3
import tempfile
import sys
import os
from lettucethink.fsdb import DB
from optparse import OptionParser
import subprocess
import json
import requests

if __name__ == "__main__":
    usage = "usage: %prog local_db remote_db [api_url]"
    parser = OptionParser(usage=usage)
    (options, args) = parser.parse_args()

    if '-n' in sys.argv:
        i = find('-n')

    if len(args) != 3 and len(args) != 2:
        raise Exception(
            'Wrong number of arguments. Type %prog --help for more.')

    for d in os.listdir(args[0]):
        subprocess.run(["run-pipeline", os.path.join(args[0], d), "--task", "Visualization"])

    subprocess.run(["rsync", "-av", args[0] + "/", args[1]], check=True)

    if len(args) == 3:
        api_url = args[2]
        if api_url[-1] == '/':
            api_url = api_url[:-1]
        requests.get(api_url + "/refresh")
